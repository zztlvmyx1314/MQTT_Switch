
#include "mqtt.h"
#include "usart.h"
#include "esp8266.h"

uint8_t PING[2]={0xc0,0x00};
uint8_t MQTTCONN[120]=
{0x10,0x76,0x00,0x04,0x4d,0x51,0x54,0x54,0x04,0xc2,0x00,0x3c,0x00,0x27,0x31,0x32,
0x33,0x34,0x35,0x7c,0x73,0x65,0x63,0x75,0x72,0x65,0x6d,0x6f,0x64,0x65,0x3d,0x33,
0x2c,0x73,0x69,0x67,0x6e,0x6d,0x65,0x74,0x68,0x6f,0x64,0x3d,0x68,0x6d,0x61,0x63,
0x73, 0x68,0x61,0x31,0x7c,0x00,0x17,0x4c,0x61,0x6d,0x70,0x5f,0x53,0x77,0x69,0x74,
0x63,0x68,0x26,0x61,0x31,0x31,0x39,0x70,0x48,0x51,0x45,0x46,0x53,0x72,0x00,0x28,
0x43,0x43,0x42,0x30,0x36,0x42,0x45,0x32,0x33,0x38,0x46,0x32,0x46,0x38,0x30,0x46,
0x35,0x46,0x43,0x46,0x45,0x30,0x35,0x34,0x31,0x44,0x35,0x44,0x30,0x46,0x35,0x45,
0x32,0x38,0x46,0x35,0x32,0x44,0x30,0x32
};

void MQTT_Message(uint8_t* data,uint16_t len){

     uint16_t num=120;
	
	 char* ack="OK";
     
	   uint8_t count=4;
	
	  do {
		 
		  
			printf("AT+CIPSEND=%d\r\n",len);
	
	    HAL_Delay(500);
			 
			if(ESP_CheckBack(ack)==Success){
			
				break;
			}
			
			 
		 
		 } while(count--);
	
    count=4;
		 
		 do {
		 
		  
			HAL_UART_Transmit(&UART1_Handler,(uint8_t*)data,num,0xffff);
	
	    HAL_Delay(500);
			 
			if(ESP_CheckBack("SEND OK")==Success){
			
				return;
			}
			
			 
		 
		 } while(count--);

}


uint16_t MesLen(uint8_t mes[]){

	    uint16_t size=0;
	    uint16_t i=0;
	
     while(mes[i]!=0){
		 
			   size++;
		     
		    i++;
		 
		 }
	
   return size;

}
